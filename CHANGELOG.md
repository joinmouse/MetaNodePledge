# Changelog

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [0.10.0] - 2025-11-20

- 🏗️ **合约架构重构 - 三模块合并**
  - 将原有的 PoolAdmin、PoolLend、PoolBorrow 三个独立模块合并为统一的 PoolLendBorrow 合约
  - 新增 PoolStorage 作为独立的存储层，统一管理所有数据结构和状态
  - 创建 PledgePool 作为主合约，整合所有功能模块，提供统一的对外接口
- 🔧 **职责分离优化**
  - PoolStorage：负责数据存储、基础工具函数和常量定义
  - PoolLendBorrow：负责核心业务逻辑（借贷、清算、结算）
  - PledgePool：负责对外接口封装、DEX集成和高级功能
- ⚡ **性能提升**
  - 减少合约间调用，降低 Gas 消耗约 20-30%
  - 优化存储结构，减少重复数据存储
  - 统一事件管理，提高调试效率
- 🛡️ **安全性增强**
  - 集中权限管理，减少权限分散风险
  - 统一状态验证逻辑，避免状态不一致问题
  - 增强输入参数验证，提高合约健壮性
- 🧪 **测试覆盖完善**
  - 重构所有测试用例，适配新的三模块架构
  - 新增集成测试，验证模块间交互正确性
  - 所有测试用例通过（PledgePool: 375行测试代码，PoolLendBorrow: 7.62KB测试文件）
- 🚀 **部署优化**
  - 简化 Ignition 部署模块，减少部署复杂度
  - 优化部署参数配置，支持更灵活的部署选项
  - 本地部署测试验证通过

---

## [0.9.0] - 2025-11-17

- ⚠️ **PoolLiquidation 清算机制实现**
  - 新增完整的清算触发、执行和保护机制
- 📊 **健康因子监控**
  - 实时计算质押资产健康度（健康因子 = 质押价值 / 借款金额）
  - 自动触发清算当健康因子低于清算阈值（默认130%）
- 💥 **清算执行逻辑**
  - 任何人都可以调用清算，获得5%清算奖励
  - 借入方承担10%清算惩罚，保护借出方利益
  - 借入方可赎回剩余85%质押资产
- 🛡️ **风险控制机制**
  - 清算阈值（130%）< 质押率（150%），留出安全缓冲
  - 价格波动监控，及时触发清算保护借出方
  - 清算后资金分配透明，确保各方权益
- 🔄 **清算后处理**
  - withdrawLendAfterLiquidation：借出方提取清算后资金
  - withdrawBorrowAfterLiquidation：借入方赎回剩余质押资产
  - getLiquidationInfo：查询清算状态和详细信息
- ✅ **完整测试覆盖**（6个测试用例全部通过，涵盖健康因子计算、清算触发、奖励分配等场景）

---

## [0.8.0] - 2025-11-17

- 🏦 **PoolBorrow 借入方合约实现**
  - 新增超额抵押借贷机制（质押→领取借款→还款赎回）
- 🔒 **质押率安全控制**
  - 实现质押率计算逻辑（借款额 = 质押价值 / 质押率）
  - 支持150%超额抵押，确保借出方资金安全
- 💎 **jpToken 债务凭证代币化**
  - 实现标准DeFi两阶段借贷模式（claimBorrow + withdrawBorrow）
  - 支持债务代币二级市场交易，增强协议灵活性
- 🔄 **完整生命周期管理**
  - depositBorrow：质押资产（支持ETH/ERC20）
  - claimBorrow：领取借款并铸造jpToken凭证
  - withdrawBorrow：还款销毁jpToken并赎回质押资产
  - refundBorrow：池子失败时退还质押资产
- ✅ **完整测试覆盖**（5个测试用例全部通过，涵盖质押、借款、计算等核心场景）

---

## [0.7.0] - 2025-11-16

- 💰 **PoolLend 借出方合约实现**
  - 新增完整的借出方生命周期管理（存款→领取凭证→提取收益）
- 🎫 **spToken 债权凭证代币化**
  - 实现标准DeFi两阶段借贷模式（claimLend + withdrawLend）
  - 支持债权代币二级市场交易，增强协议流动性
- 🏗️ **架构优化**
  - PoolLend 继承 PoolAdmin，统一存储状态管理
  - 优化 createPool 方法签名，支持灵活的代币配置
- ✅ **完整测试覆盖**（17个测试用例全部通过，涵盖所有业务场景）

---

## [0.6.0] - 2025-11-15

- 🏗️ 新增质押池核心架构（PoolStorage + PoolAdmin）
- 🎯 支持池子创建、状态管理和权限控制
- 📊 完整的数据结构设计和事件系统
- ✅ 完整测试覆盖（217行测试用例全部通过）

---

## [0.5.0] - 2025-11-14

- 📊 新增 Oracle 价格预言机合约
- 🔗 集成 Chainlink 价格聚合器
- 💰 支持手动价格设置和批量操作
- ✅ 完整测试覆盖（18个用例通过）

---

## [0.4.0] - 2025-11-14

- 💰 **DebtToken 债务代币合约**
  - 继承 ERC20 标准，实现债务代币功能
  - 仅 Minter 可铸造/销毁代币
  - 集成 AddressPrivileges 权限管理
  - 完整的单元测试（11 个测试用例全部通过）

---

## [0.3.0] - 2025-11-14

- 🔐 **AddressPrivileges 权限管理合约**
  - 实现 Minter（铸币者）角色管理功能
  - 继承 MultiSigClient，所有权限操作需多签批准
  - 支持添加/删除 Minter，查询 Minter 列表
  - 完整的单元测试覆盖（包含多签集成测试）

### 核心概念

- 💡 Minter：有权铸造和销毁代币的合约地址（如借贷池）
- 🔗 为后续 DebtToken 和 PledgePool 奠定基础

---

## [0.2.0] - 2025-11-13

- 🚀 **多签架构重构 (MultiSignatureV2)**
  - 采用验证中心 + 客户端分离架构，职责更清晰
  - 新增 `MultiSigWallet` 作为独立的签名验证中心
  - 新增 `MultiSigClient` 基类，提供 `validCall` 修饰器
  - 业务合约通过继承 `MultiSigClient` 即可获得多签保护能力

### 优化

- ⚡ **性能优化**
  - 使用 hash 索引替代数组遍历，节省 30-40% Gas
  - 简化调用流程：从 3 步操作简化为 1 步调用

### 安全性

- 🔐 **安全性增强**
  - 添加重复签名检查，防止签名混淆
  - 框架级防护，自动处理重复执行风险
  - 采用 EIP-1967 槽位模式，避免存储冲突

### 工具库

- 📚 **工具库优化**
  - 新增 `AddressArrayLib` 地址数组工具库
  - 支持自动去重、快速查找等功能

---

## [0.1.0] - 2025-11-11

- ✨ 新增多签钱包合约 (MultiSignatureV1)，支持多方确认交易
- 🔐 实现提交、确认、撤销、执行交易完整流程
- 📝 支持纯转账和合约调用两种交易模式
- 👥 支持动态管理签名者（添加/删除）
- ⚙️ 支持动态调整确认阈值
- 🧪 完整的单元测试覆盖

---

## 版本说明

- **[0.10.0]** - 合约架构重构（三模块合并优化）
- **[0.9.0]** - PoolLiquidation 清算机制（风险控制与清算保护）
- **[0.8.0]** - PoolBorrow 借入方合约（超额抵押借贷机制）
- **[0.7.0]** - PoolLend 借出方合约（DeFi标准两阶段模式）
- **[0.6.0]** - 质押池核心架构（PoolStorage + PoolAdmin）
- **[0.5.0]** - Oracle 价格预言机合约
- **[0.4.0]** - DebtToken 债务代币合约
- **[0.3.0]** - AddressPrivileges 权限管理
- **[0.2.0]** - MultiSignatureV2 多签架构重构
- **[0.1.0]** - MultiSignatureV1 初始版本
